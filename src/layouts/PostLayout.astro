---
import { Image } from 'astro:assets';
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import headshotAuthor from '../assets/headshot-author-v2.jpg';

interface PostLink {
  title: string;
  href: string;
}

interface Props {
  title: string;
  pageTitle?: string;
  subtitle?: string;
  author?: string;
  authorBio?: string;
  date?: Date;
  description?: string;
  prevPost?: PostLink;
  nextPost?: PostLink;
}

const {
  title,
  pageTitle,
  subtitle,
  author = 'Chris Olberding',
  authorBio = 'Chris writes about technology, design, and the ideas that shape how we live and work. He builds things on the web and reads widely across fields.',
  date,
  description,
  prevPost,
  nextPost,
} = Astro.props;

const publishedDate = date
  ? date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
    })
  : null;
---

<BaseLayout title={pageTitle || `Chris Olberding | ${title}`} description={description} ogType="article">
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": description,
    "author": {
      "@type": "Person",
      "name": author,
      "url": "https://olberding.me/about"
    },
    ...(date && { "datePublished": date.toISOString() }),
    "publisher": {
      "@type": "Person",
      "name": "Chris Olberding"
    }
  })} />
  <Header variant="page" />
  <div class="page-top-border" aria-hidden="true"></div>
  <div class="scroll-progress scroll-progress--left" aria-hidden="true"></div>
  <div class="scroll-progress scroll-progress--right" aria-hidden="true"></div>

  <main class="post">
    <header class="post__header">
      <h1 class="post__title">{title}</h1>
      {subtitle && <p class="post__subtitle">{subtitle}</p>}
    </header>

    <article class="post__body prose">
      <slot />
    </article>

    <footer class="post__footer">
      <!-- Published date -->
      <div class="post__meta">
        {publishedDate && <span>Published {publishedDate}</span>}
      </div>

      <!-- Author bio + contact -->
      <div class="post__bio">
        <Image src={headshotAuthor} alt="" class="post__bio-photo" width={144} />
        <div class="post__bio-body">
          <div class="post__bio-header">
            <strong>{author}</strong>
            <div class="post__bio-icons">
              <a href="#" aria-label="Email me" data-contact-open>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <a href="https://www.linkedin.com/in/chrisolberding/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
              </a>
            </div>
          </div>
          <p>{authorBio}</p>
        </div>
      </div>

      <!-- Prev / Next navigation -->
      {(prevPost || nextPost) && (
        <nav class="post__nav">
          <div class="post__nav-prev">
            {prevPost && (
              <a href={prevPost.href}>
                <span class="post__nav-label">
                  <span class="post__nav-arrow post__nav-arrow--left" aria-hidden="true">&larr;</span>
                  Previous
                </span>
                <span class="post__nav-title">{prevPost.title}</span>
              </a>
            )}
          </div>
          <div class="post__nav-next">
            {nextPost && (
              <a href={nextPost.href}>
                <span class="post__nav-label">
                  Next
                  <span class="post__nav-arrow post__nav-arrow--right" aria-hidden="true">&rarr;</span>
                </span>
                <span class="post__nav-title">{nextPost.title}</span>
              </a>
            )}
          </div>
        </nav>
      )}
    </footer>
  </main>

  <!-- Table of Contents -->
  <nav class="toc" id="toc" aria-label="Table of contents">
    <button class="toc__btn" id="toc-btn" aria-expanded="false" aria-label="Table of contents">
      <svg width="44" height="44" viewBox="0 0 44 44" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <line x1="12" y1="14" x2="32" y2="14"/>
        <line x1="12" y1="22" x2="26" y2="22"/>
        <line x1="12" y1="30" x2="32" y2="30"/>
      </svg>
    </button>

    <div class="toc__modal" id="toc-modal" aria-hidden="true" inert>
      <div class="toc__modal-inner">
        <ol class="toc__list" id="toc-list">
          <!-- Populated by JS -->
        </ol>
        <div class="toc__meta" id="toc-meta">
          {publishedDate && <span class="toc__meta-item">Published {publishedDate}</span>}
          <span class="toc__meta-item" id="toc-meta-words"></span>
          <span class="toc__meta-item" id="toc-meta-time"></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Floating citation preview -->
  <div class="cite-preview" id="cite-preview" aria-live="polite">
    <button class="cite-preview__close" aria-label="Dismiss">&times;</button>
    <span class="cite-preview__num"></span>
    <span class="cite-preview__text"></span>
  </div>

  <div class="page-bottom-border" aria-hidden="true"></div>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    // External links open in new tab
    document.querySelectorAll('.post__body a[href^="http"]').forEach(a => {
      if (!a.getAttribute('href')?.startsWith(window.location.origin)) {
        a.setAttribute('target', '_blank');
        a.setAttribute('rel', 'noopener');
      }
    });

    const bars = document.querySelectorAll('.scroll-progress') as NodeListOf<HTMLElement>;
    if (bars.length) {
      function updateProgress() {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const pct = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
        bars.forEach(bar => { bar.style.transform = `scaleY(${pct})`; });
      }
      window.addEventListener('scroll', updateProgress, { passive: true });
      updateProgress();
    }

    // Citation preview
    const citeRefs = document.querySelectorAll('.cite-ref');
    const preview = document.getElementById('cite-preview');
    if (citeRefs.length && preview) {
      const previewNum = preview.querySelector('.cite-preview__num') as HTMLElement;
      const previewText = preview.querySelector('.cite-preview__text') as HTMLElement;
      const closeBtn = preview.querySelector('.cite-preview__close') as HTMLElement;

      // Build reference map from the references list
      const refMap = new Map<string, string>();
      document.querySelectorAll('.references li').forEach(li => {
        const id = li.id; // e.g. "ref-1"
        const num = id.replace('ref-', '');
        const clone = li.cloneNode(true) as HTMLElement;
        clone.querySelectorAll('.cite-back').forEach(el => el.remove());
        refMap.set(num, clone.textContent?.trim() || '');
      });

      let activeRef: string | null = null;
      let hideTimeout: ReturnType<typeof setTimeout> | null = null;
      let dismissed = false;

      function showPreview(refNum: string) {
        if (dismissed) return;
        if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
        const text = refMap.get(refNum);
        if (!text) return;
        previewNum.textContent = refNum;
        previewText.textContent = text;
        preview.classList.add('is-visible');
        activeRef = refNum;
      }

      function hidePreview() {
        hideTimeout = setTimeout(() => {
          preview.classList.remove('is-visible');
          activeRef = null;
        }, 300);
      }

      closeBtn.addEventListener('click', () => {
        preview.classList.remove('is-visible');
        dismissed = true;
        activeRef = null;
      });

      const citeObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const refNum = (entry.target as HTMLElement).dataset.ref;
          if (!refNum) return;
          if (entry.isIntersecting) {
            showPreview(refNum);
          } else if (activeRef === refNum) {
            hidePreview();
          }
        });
      }, { threshold: 1.0 });

      citeRefs.forEach(ref => citeObserver.observe(ref));
    }

    // ── Table of Contents ──
    const tocNav = document.getElementById('toc') as HTMLElement | null;
    const postBody = document.querySelector('.post__body') as HTMLElement | null;
    const postHeader = document.querySelector('.post__header') as HTMLElement | null;

    if (tocNav && postBody) {
      const allHeadings = postBody.querySelectorAll('h2, h3') as NodeListOf<HTMLHeadingElement>;

      // Filter out headings inside .key-points and "References" h2
      const headings = Array.from(allHeadings).filter(h => {
        if (h.closest('.key-points')) return false;
        if (h.tagName !== 'H2') return false;
        if (h.textContent?.trim().toLowerCase() === 'references') return false;
        return true;
      });

      const h2Count = headings.filter(h => h.tagName === 'H2').length;

      if (h2Count >= 3) {
        tocNav.classList.add('toc--active');

        const tocList = document.getElementById('toc-list') as HTMLElement;
        const tocBtn = document.getElementById('toc-btn') as HTMLElement;
        const tocModal = document.getElementById('toc-modal') as HTMLElement;
        const headerEl = document.querySelector('.header') as HTMLElement | null;

        // Build TOC list — start with the article title
        const postTitle = postHeader?.querySelector('.post__title') as HTMLElement | null;
        if (postTitle) {
          if (!postTitle.id) postTitle.id = 'post-title';
          const titleLi = document.createElement('li');
          titleLi.className = 'toc__item toc__item--title';
          titleLi.innerHTML = `<a href="#${postTitle.id}" class="toc__link" data-toc-target="${postTitle.id}">${postTitle.textContent?.trim() || ''}</a>`;
          tocList.appendChild(titleLi);
        }

        headings.forEach((heading, i) => {
          if (!heading.id) heading.id = 'heading-' + i;
          const text = heading.textContent?.trim() || '';

          const li = document.createElement('li');
          li.className = 'toc__item';
          li.innerHTML = `<a href="#${heading.id}" class="toc__link" data-toc-target="${heading.id}">${text}</a>`;
          tocList.appendChild(li);
        });

        // Click handlers — smooth scroll
        tocList.querySelectorAll('.toc__link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = (link as HTMLElement).dataset.tocTarget;
            if (!targetId) return;
            const target = document.getElementById(targetId);
            if (!target) return;
            closeToc();
            const offset = 30;
            const y = target.getBoundingClientRect().top + window.scrollY - offset;
            window.scrollTo({ top: y, behavior: 'smooth' });
          });
        });

        // Active section tracking
        let currentActiveId: string | null = null;

        function setActive(id: string) {
          if (id === currentActiveId) return;
          currentActiveId = id;
          tocList.querySelectorAll('.toc__link').forEach(link => {
            const isActive = (link as HTMLElement).dataset.tocTarget === id;
            link.classList.toggle('is-active', isActive);
            link.parentElement?.classList.toggle('is-active', isActive);
          });
        }

        const tocObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              setActive(entry.target.id);
            }
          });
        }, { rootMargin: '-10px 0px -70% 0px', threshold: 0 });

        headings.forEach(h => tocObserver.observe(h));

        // Reset active state when above first heading
        const firstHeading = headings[0];
        if (firstHeading) {
          window.addEventListener('scroll', () => {
            if (window.scrollY < firstHeading.offsetTop - 100) {
              if (currentActiveId !== null) {
                currentActiveId = null;
                tocList.querySelectorAll('.toc__link').forEach(link => {
                  link.classList.remove('is-active');
                  link.parentElement?.classList.remove('is-active');
                });
              }
            }
          }, { passive: true });
        }

        // Show button immediately, hide when past article body
        tocBtn?.classList.add('is-visible');

        // Compute word count and reading time
        const bodyText = postBody.textContent || '';
        const wordCount = bodyText.split(/\s+/).filter(w => w.length > 0).length;
        const readingMin = Math.max(1, Math.round(wordCount / 250));
        const wordsEl = document.getElementById('toc-meta-words');
        const timeEl = document.getElementById('toc-meta-time');
        if (wordsEl) wordsEl.textContent = wordCount.toLocaleString() + ' words';
        if (timeEl) timeEl.textContent = readingMin + ' min read';

        if (tocBtn) {
          const btnBodyObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              tocBtn.classList.toggle('is-past', !entry.isIntersecting);
            });
          }, { threshold: 0 });
          btnBodyObserver.observe(postBody);
        }

        // Sync with header scroll-hide (at narrow widths the header hides on scroll-down)
        if (headerEl && tocBtn) {
          const syncObserver = new MutationObserver(() => {
            tocBtn.classList.toggle('is-header-hidden', headerEl.classList.contains('is-hidden'));
          });
          syncObserver.observe(headerEl, { attributes: true, attributeFilter: ['class'] });
        }

        // Modal open/close
        function closeToc() {
          tocModal?.classList.remove('is-open');
          tocModal?.setAttribute('aria-hidden', 'true');
          tocModal?.setAttribute('inert', '');
          tocBtn?.setAttribute('aria-expanded', 'false');
          tocBtn?.classList.remove('is-modal-open');
          document.body.style.overflow = '';
        }

        function openToc() {
          tocModal?.classList.add('is-open');
          tocModal?.setAttribute('aria-hidden', 'false');
          tocModal?.removeAttribute('inert');
          tocBtn?.setAttribute('aria-expanded', 'true');
          tocBtn?.classList.add('is-modal-open');
          document.body.style.overflow = 'hidden';
        }

        tocBtn?.addEventListener('click', () => {
          if (tocModal?.classList.contains('is-open')) {
            closeToc();
          } else {
            openToc();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && tocModal?.classList.contains('is-open')) {
            closeToc();
          }
        });
      }
    }
  });
</script>

<style>
  .scroll-progress {
    position: fixed;
    top: 0;
    width: 10px;
    height: 100%;
    background-color: var(--color-accent);
    transform-origin: top;
    transform: scaleY(0);
    z-index: 400;
    pointer-events: none;
  }

  .page-top-border {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 10px;
    background-color: var(--color-accent);
    z-index: 400;
    pointer-events: none;
  }

  .scroll-progress--left { left: 0; }
  .scroll-progress--right { right: 0; }

  .page-bottom-border {
    width: 100%;
    height: 10px;
    background-color: var(--color-accent);
  }


  .post {
    max-width: 700px;
    margin: 0 auto;
    padding: 6rem var(--spacing-md) var(--spacing-xl);
  }

  .post__header {
    margin-bottom: var(--spacing-lg);
    position: relative;
  }

  .post__header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2.5rem;
    width: 10px;
    height: 100%;
    background-color: var(--color-accent);
  }

  .post__title {
    font-family: 'Outfit', var(--font-sans);
    font-size: 3.6rem;
    font-weight: 700;
    line-height: 1.1;
    letter-spacing: -0.02em;
    color: var(--color-accent-text);
    margin-bottom: 0.15em;
  }

  .post__subtitle {
    font-family: 'Literata', var(--font-serif);
    font-size: 1.5rem;
    font-weight: 400;
    line-height: 1.45;
    color: var(--color-text);
  }

  .post__body {
    margin-top: var(--spacing-md);
    font-family: 'Literata', var(--font-serif);
  }

  .post__body :global(h2),
  .post__body :global(h3) {
    font-family: 'Outfit', var(--font-sans);
  }

  /* Footer sections */
  .post__footer {
    margin-top: var(--spacing-md);
  }

  /* Author bio */
  .post__bio {
    padding: var(--spacing-md) 0;
    border-top: 1px solid var(--color-accent);
    border-bottom: 1px solid var(--color-accent);
    display: flex;
    gap: 1.2rem;
    align-items: flex-start;
  }

  .post__bio-photo {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    object-fit: cover;
    object-position: calc(50% - 4px) 20%;
    flex-shrink: 0;
  }

  .post__bio-body {
    flex: 1;
    min-width: 0;
  }

  .post__bio-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .post__bio-header strong {
    font-family: 'Outfit', var(--font-sans);
    font-size: 1.05rem;
  }

  .post__bio p {
    font-family: 'Literata', var(--font-serif);
    font-size: 0.8rem;
    line-height: 1.6;
    margin: 0;
  }

  .post__bio-icons {
    display: flex;
    gap: 0.6rem;
  }

  .post__bio-icons a {
    color: var(--color-text);
    display: flex;
    transition: opacity 0.2s;
  }

  .post__bio-icons a:hover {
    color: var(--color-accent-text);
  }

  /* Published date */
  .post__meta {
    padding: var(--spacing-sm) 0 var(--spacing-md);
    font-family: 'Literata', var(--font-serif);
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  /* Prev / Next nav */
  .post__nav {
    display: flex;
    justify-content: space-between;
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
  }

  .post__nav-prev,
  .post__nav-next {
    flex: 1;
    min-width: 0;
  }

  .post__nav-next {
    text-align: right;
  }

  .post__nav a {
    text-decoration: none;
    display: block;
  }

  .post__nav-prev a:hover .post__nav-arrow {
    transform: translateX(-3px);
  }

  .post__nav-next a:hover .post__nav-arrow {
    transform: translateX(3px);
  }

  .post__nav a:hover .post__nav-title {
    color: var(--color-accent-text);
  }

  .post__nav-label {
    display: flex;
    align-items: center;
    gap: 0.35em;
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    margin-bottom: 0.2em;
  }

  .post__nav-next .post__nav-label {
    justify-content: flex-end;
  }

  .post__nav-arrow {
    display: inline-block;
    transition: transform 0.25s ease;
  }

  .post__nav-title {
    font-family: 'Literata', var(--font-serif);
    font-size: 0.85rem;
    color: var(--color-text);
    line-height: 1.4;
    transition: color 0.25s ease;
  }

  @media (max-width: 1110px) {
    .post__header::before {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .post {
      padding: 5rem var(--spacing-md) var(--spacing-lg);
    }

    .post__body {
      font-size: 0.9rem;
    }

    .post__title {
      font-size: 2.2rem;
    }

    .post__subtitle {
      font-size: 1.15rem;
    }

    .post__nav {
      flex-direction: column;
    }

    .post__nav-next {
      text-align: left;
    }
  }

  @media (max-width: 400px) {
    .post__bio {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .post__bio-header {
      justify-content: center;
    }
  }

  /* ── Citation markers ── */
  .post__body :global(.cite-ref) {
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.65em;
    line-height: 1;
    vertical-align: super;
    margin-right: 2px;
  }

  .post__body :global(.cite-ref a) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5em;
    height: 1.5em;
    border-radius: 50%;
    background: var(--color-accent);
    color: var(--color-accent-text);
    text-decoration: none;
    font-weight: 700;
    transition: background 0.2s, transform 0.2s;
  }

  .post__body :global(.cite-ref a:hover) {
    background: var(--color-accent-text);
    color: var(--color-bg);
    transform: scale(1.15);
  }

  /* ── References section ── */
  .post__body :global(.references) {
    list-style: none;
    padding: 0;
    counter-reset: ref-counter;
  }

  .post__body :global(.references li) {
    counter-increment: ref-counter;
    position: relative;
    padding-left: 2rem;
    margin-bottom: 1.2rem;
    font-size: 0.82rem;
    line-height: 1.6;
    color: var(--color-text);
    scroll-margin-top: 1.5rem;
  }

  .post__body :global(.references li::before) {
    content: counter(ref-counter);
    position: absolute;
    left: 0;
    top: 0.1em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.4em;
    height: 1.4em;
    border-radius: 50%;
    background: var(--color-accent);
    color: var(--color-accent-text);
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.8em;
    font-weight: 700;
  }

  .post__body :global(.cite-back) {
    text-decoration: none;
    margin-left: 0.3em;
    color: var(--color-accent-text);
  }

  .post__body :global(.cite-back:hover) {
    text-decoration: underline;
  }

  /* ── Floating citation preview ── */
  .cite-preview {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(calc(100% + 2rem));
    max-width: 640px;
    width: calc(100% - 3rem);
    background: var(--color-bg);
    border: 1px solid var(--color-accent);
    border-left: 5px solid var(--color-accent);
    border-radius: 6px;
    padding: 0.8rem 2.4rem 0.8rem 0.8rem;
    display: flex;
    gap: 0.7rem;
    align-items: flex-start;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    z-index: 500;
    opacity: 0;
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.25s ease;
    pointer-events: none;
  }

  .cite-preview.is-visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .cite-preview__num {
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: var(--color-accent);
    color: var(--color-accent-text);
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.75rem;
    font-weight: 700;
    margin-top: 0.1rem;
  }

  .cite-preview__text {
    font-family: 'Literata', var(--font-serif);
    font-size: 0.78rem;
    line-height: 1.55;
    color: var(--color-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .cite-preview__close {
    position: absolute;
    top: 0.4rem;
    right: 0.5rem;
    background: none;
    border: none;
    font-size: 1.1rem;
    color: var(--color-text-light);
    cursor: pointer;
    padding: 0.2rem;
    line-height: 1;
    transition: color 0.2s;
  }

  .cite-preview__close:hover {
    color: var(--color-accent-text);
  }

  /* ── Table of Contents ── */
  .toc {
    display: none;
  }

  .toc.toc--active {
    display: block;
  }

  /* TOC button — top-right, mirrors logo button top-left */
  .toc__btn {
    position: fixed;
    top: var(--spacing-md);
    right: var(--spacing-md);
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text);
    padding: 0;
    line-height: 0;
    z-index: 520;
    pointer-events: auto;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease, color 0.2s;
  }

  .toc__btn.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .toc__btn.is-past {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
  }

  .toc__btn:hover {
    color: var(--color-accent-text);
  }

  .toc__btn.is-modal-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Sync with header scroll-hide at narrow widths */
  @media (max-width: 900px) {
    .toc__btn.is-header-hidden {
      opacity: 0;
      transform: translateY(-100%);
      pointer-events: none;
    }
  }

  /* Full-screen TOC modal */
  .toc__modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--color-bg);
    z-index: 510;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    box-shadow: inset 10px 0 0 0 var(--color-accent),
                inset -10px 0 0 0 var(--color-accent),
                inset 0 10px 0 0 var(--color-accent),
                inset 0 -10px 0 0 var(--color-accent);
  }

  .toc__modal.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .toc__modal-inner {
    width: 100%;
    max-width: 520px;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    padding: 0 var(--spacing-md);
  }

  .toc__list {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: toc-section;
  }

  .toc__list :global(.toc__item) {
    counter-increment: toc-section;
    transition: border-color 0.2s ease;
  }

  .toc__list :global(.toc__link) {
    display: flex;
    align-items: baseline;
    gap: 0.8rem;
    padding: 0.6rem 0;
    font-family: 'Outfit', var(--font-sans);
    font-size: 1.1rem;
    font-weight: 400;
    line-height: 1.35;
    color: var(--color-text-light);
    text-decoration: none;
    transition: color 0.15s;
  }

  .toc__list :global(.toc__item:not(.toc__item--title) .toc__link::before) {
    content: counter(toc-section, decimal-leading-zero);
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--color-accent-text);
    flex-shrink: 0;
    min-width: 1.4em;
  }

  .toc__list :global(.toc__item--title) {
    counter-increment: none;
    margin-bottom: 1.2rem;
    padding-bottom: 1.2rem;
    border-bottom: 10px solid var(--color-accent);
  }

  .toc__list :global(.toc__item--title .toc__link) {
    font-weight: 700;
    font-size: 1.6rem;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: var(--color-text);
  }

  .toc__list :global(.toc__link:hover) {
    color: var(--color-text);
  }

  .toc__list :global(.toc__link.is-active) {
    color: var(--color-accent-text);
    font-weight: 700;
  }

  .toc__list :global(.toc__item.is-active .toc__link::before) {
    color: var(--color-accent-text);
  }

  /* Metadata footer */
  .toc__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem 1.5rem;
    margin-top: 2rem;
    padding-top: 1.2rem;
    border-top: 10px solid var(--color-accent);
  }

  .toc__meta-item {
    font-family: 'Outfit', var(--font-sans);
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.02em;
    color: var(--color-text-light);
  }

  .toc__meta-item:empty {
    display: none;
  }
</style>
